# XPathAi
Расширение для Chrome, упрощающее поиск устойчивых XPath-локаторов с использованием AI-сервисов.

## Структура проекта

- **extension/**
  - `contentScript.js` – скрипт для подсветки и выбора элементов на веб-странице
  - `background.js` – фоновый сервис-воркер для обработки сообщений
  - `popup/*` – интерфейс расширения
  - `options.*` – страница настроек расширения
  - `prompts/` – шаблоны промптов для AI

- **backend/** (опционально, для локального AI)
  - `main.py` – FastAPI сервер с llama.cpp
  - `main_ollama.py` – FastAPI сервер с Ollama
  - Docker конфигурации для разных сценариев

## Как работает расширение

1. **Выбор элемента**: По клику на кнопку «🔍» активируется режим выбора элемента на странице.
2. **Подсветка и выбор**: `contentScript.js` обрабатывает наведение мыши и подсвечивает элементы. При клике элемент выбирается.
3. **Генерация XPath**: После выбора элемента `background.js` генерирует несколько XPath-локаторов:
   - Основной XPath
   - Альтернативный XPath
4. **AI-интеграция**: При включенном AI-режиме данные отправляются на внешний AI-сервис для генерации XPath.
5. **Проверка уникальности**: Возможность проверить количество элементов, найденных по сгенерированному XPath и подсветить их на странице.
6. **Копирование**: Клик по полю XPath копирует его в буфер обмена для использования в тестах.

## Настройка AI-интеграции

Расширение может работать автономно, генерируя базовые XPath-локаторы. Для расширенных возможностей доступно два варианта AI-интеграции:

### Вариант 1: Локальный backend (рекомендуется)

**С Ollama:**
1. Установите Ollama с https://ollama.ai/
2. Установите модель: `ollama pull qwen2.5:3b`
3. Запустите backend:
   ```cmd
   cd backend
   start_backend_venv.cmd
   # Выберите опцию 2 (Ollama)
   ```
4. В настройках расширения укажите:
   - **API URL**: `http://localhost:8000/generate-xpath`
   - **Model Name**: `qwen2.5:3b`

**С llama.cpp:**
1. Запустите: `cd backend && docker-compose up -d --build`
2. В настройках расширения укажите:
   - **API URL**: `http://localhost:8000/generate-xpath`

### Вариант 2: Внешний AI-сервис

1. Откройте настройки расширения (⚙️)
2. Укажите параметры AI-сервиса:
   - **API URL**
   - **API ключ**
   - **Название модели**

Тестировалось на моделях:
- THUDM/glm-4-9b-chat
- deepseek-ai/DeepSeek-R1-Distill-Qwen-7B
- Qwen/Qwen2.5-Coder-7B-Instruct

## Установка расширения

1. Откройте Google Chrome и перейдите в «Расширения» → «Управление расширениями» (`chrome://extensions/`)
2. Включите «Режим разработчика» в правом верхнем углу
3. Нажмите «Загрузить распакованное расширение» и выберите папку `extension`
4. Расширение появится в панели браузера

## Использование

1. **Откройте веб-страницу**, на которой нужно найти XPath-локатор
2. **Кликните на иконку расширения** XPathAi в панели браузера
3. **Нажмите «🔍»** для активации режима выбора
4. **Наведите курсор на нужный элемент** (он подсветится) и **кликните** для выбора
5. **Получите результат**:
   - Основной XPath в верхнем поле
   - Альтернативный XPath в нижнем поле (опционально)
   - Объяснение логики генерации (опционально)
6. **Кликните по полю XPath** для копирования в буфер обмена
7. **Используйте дополнительные функции**:
   - **🦄 Поиск дублей** – показывает количество найденных элементов и подсвечивает их
   - **🤖** – переключает режим AI-генерации
   - **🔄️** – очищает результаты

> **Backend Setup:** Подробные инструкции по настройке локального backend (Ollama, llama.cpp, Docker) доступны в файле `BACKEND_SETUP.md`. Локальный backend обеспечивает приватность данных и не требует внешних API ключей.

## Лицензия

Проект распространяется «как есть». Вносите любые изменения и улучшения по своему усмотрению.

## Схема взаимодействия

### Архитектура компонентов
```
┌─────────────┐    ┌──────────────┐    ┌─────────────────┐
│   Popup     │◄──►│  Background  │◄──►│  ContentScript  │
│   (UI)      │    │  (Service    │    │  (Web Page)     │
│             │    │   Worker)    │    │                 │
└─────────────┘    └──────────────┘    └─────────────────┘
       │                   │                     │
       ▼                   ▼                     ▼
┌─────────────┐    ┌──────────────┐    ┌─────────────────┐
│   Chrome    │    │  AI Service  │    │    DOM Tree     │
│   Storage   │    │   (External) │    │   (Website)     │
└─────────────┘    └──────────────┘    └─────────────────┘
```

### Основные потоки сообщений

#### 1. Активация выбора элемента
```
Popup ── action: "initSelection" ──► Background ── action: "activateSelection" ──► ContentScript
  │                                                                                 │
  └── tabId, useAI                                                                  └── Активирует режим выбора
```

#### 2. Генерация XPath
```
ContentScript ── action: "generateXPath" ──► Background ──► AI Service (опционально)
     │                                        │                │
     └── DOM, element data, useAI             │                └── Генерация XPath
                                              ▼
                                        Chrome Storage ◄─── Результат
                                              │
                                              ▼
                                            Popup ◄─── storage.onChanged
                                              │
                                              └── Обновление UI
```

#### 3. Проверка уникальности
```
Popup ── action: "checkXpathUniqueness" ──► ContentScript
  │                                           │
  └── xpath                                   └── Подсчет элементов
                                              │
                                              ▼
                                        Chrome Storage ◄─── duplicates count
                                              │
                                              ▼
                                            Popup ◄─── storage.onChanged
```

#### 4. Подсветка дубликатов
```
Popup ── action: "highlightDuplicates" ──► ContentScript
  │                                         │
  └── xpath                                 └── Подсветка элементов на странице
```

### Типы сообщений

| Отправитель | Получатель | Тип сообщения | Назначение |
|-------------|------------|---------------|------------|
| Popup | Background | `action: "initSelection"` | Активация режима выбора |
| Background | ContentScript | `action: "activateSelection"` | Запуск выбора элемента |
| ContentScript | Background | `action: "generateXPath"` | Генерация XPath |
| Popup | ContentScript | `action: "checkXpathUniqueness"` | Проверка уникальности |
| Popup | ContentScript | `action: "highlightDuplicates"` | Подсветка дубликатов |

### Хранение данных

**Chrome Storage (local):**
- `status` - текущий статус операции
- `xpath` - основной XPath
- `alternativeXpath` - альтернативный XPath  
- `explanation` - объяснение генерации (AI)
- `error` - сообщение об ошибке
- `duplicates` - количество найденных элементов
- `isAIEnabled` - состояние AI-режима
- `apiServiceUrl` - URL AI сервиса
- `apiKey` - ключ API ⚠️
- `modelName` - название модели
- `defaultPromptTemplate` - шаблон промпта

> ⚠️ **Важно**: API ключи хранятся локально в незашифрованном виде. Используйте только тестовые ключи или ключи с ограниченными правами. Не используйте ключи с доступом к критичным данным.
